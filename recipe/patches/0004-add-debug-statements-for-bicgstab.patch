From 9a4c98ac45a596341a7b46864c29f074c5e536eb Mon Sep 17 00:00:00 2001
From: "H. Vetinari" <h.vetinari@gmx.com>
Date: Sun, 16 Jun 2024 13:38:01 +1100
Subject: [PATCH 4/4] add debug statements for bicgstab

---
 scipy/sparse/linalg/_isolve/iterative.py | 18 ++++++++++++++----
 1 file changed, 14 insertions(+), 4 deletions(-)

diff --git a/scipy/sparse/linalg/_isolve/iterative.py b/scipy/sparse/linalg/_isolve/iterative.py
index 11f7191432..3552177560 100644
--- a/scipy/sparse/linalg/_isolve/iterative.py
+++ b/scipy/sparse/linalg/_isolve/iterative.py
@@ -236,9 +236,9 @@ def bicgstab(A, b, *, x0=None, tol=_NoValue, maxiter=None, M=None,
     """
     A, M, x, b, postprocess = make_system(A, M, x0, b)
     bnrm2 = np.linalg.norm(b)
-
+    print(f"Starting bnrm2 : {bnrm2}")
     atol, _ = _get_atol_rtol('bicgstab', bnrm2, tol, atol, rtol)
-
+    print(f"Starting atol: {atol}")
     if bnrm2 == 0:
         return postprocess(b), 0
 
@@ -256,26 +256,30 @@ def bicgstab(A, b, *, x0=None, tol=_NoValue, maxiter=None, M=None,
     # sqrt might have been meant instead.
     rhotol = np.finfo(x.dtype.char).eps**2
     omegatol = rhotol
-
+    print(f"Starting paramtols rho, omega : {rhotol} / {omegatol}")
     # Dummy values to initialize vars, silence linter warnings
     rho_prev, omega, alpha, p, v = None, None, None, None, None
 
     r = b - matvec(x) if x.any() else b.copy()
     rtilde = r.copy()
-
+    print(f"Starting residual: {r}")
     for iteration in range(maxiter):
+        print(f"=============== Iteration {iteration} ========")
         if np.linalg.norm(r) < atol:  # Are we done?
             return postprocess(x), 0
 
         rho = dotprod(rtilde, r)
+        print(f"Current rho: {rho}")
         if np.abs(rho) < rhotol:  # rho breakdown
             return postprocess(x), -10
 
         if iteration > 0:
+            print(f"Omega check : {np.abs(omega)} < {omegatol}")
             if np.abs(omega) < omegatol:  # omega breakdown
                 return postprocess(x), -11
 
             beta = (rho / rho_prev) * (alpha / omega)
+            print(f"Current beta: {beta}")
             p -= omega*v
             p *= beta
             p += r
@@ -286,9 +290,15 @@ def bicgstab(A, b, *, x0=None, tol=_NoValue, maxiter=None, M=None,
         phat = psolve(p)
         v = matvec(phat)
         rv = dotprod(rtilde, v)
+        print("p", p)
+        print("phat", phat)
+        print("v", v)
+        print("rtilde", rtilde)
+        print(f"Current rv : {rv}")
         if rv == 0:
             return postprocess(x), -11
         alpha = rho / rv
+        print(f"Current alpha : {alpha}")
         r -= alpha*v
         s[:] = r[:]
 
